<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Leitor de CT-e</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind (só pra deixar bonitinho, não influencia na lógica) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    if (window['pdfjs-dist/build/pdf']) {
      const pdfjsLib = window['pdfjs-dist/build/pdf'];
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      window.pdfjsLib = pdfjsLib;
    }
  </script>

  <!-- SheetJS para gerar XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #fef3c7, #e0f2fe);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .scrollbar-thin::-webkit-scrollbar {
      height: 6px;
      width: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(148, 163, 184, 0.8);
      border-radius: 9999px;
    }
  </style>
</head>
<body class="min-h-screen flex items-start justify-center py-8">
  <div class="w-full max-w-6xl bg-white/80 shadow-xl rounded-2xl border border-slate-200 p-6 space-y-6">
    <header class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-2xl font-bold text-slate-800">Leitor de CT-e</h1>
        <p class="text-slate-600 text-sm">
          Joga os PDFs de CT-e aqui e eu monto a planilha com as infos importantes.
        </p>
      </div>
      <button id="btnXlsx"
              class="inline-flex items-center justify-center px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold disabled:opacity-40 disabled:cursor-not-allowed"
              disabled>
        Baixar XLSX
      </button>
    </header>

    <section class="space-y-3">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <p class="text-sm font-semibold text-slate-700 mb-1">
            Arquivos PDF de CT-e
          </p>
          <p class="text-xs text-slate-500">
            Aceita de 1 a 30 PDFs. Modelos TXLOG, Sudoeste, São Miguel, Princesa (iguais aos exemplos).
          </p>
        </div>
        <label class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-dashed border-slate-300 cursor-pointer bg-slate-50 hover:bg-slate-100 text-sm font-medium text-slate-700">
          <span>Selecionar arquivos</span>
          <input id="fileInput" type="file" accept="application/pdf" multiple class="hidden" />
        </label>
      </div>
      <p id="fileInfo" class="text-xs text-slate-500"></p>
      <p class="text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2">
        Dica: cada transportadora tem layout próprio. O código tenta entender pelo texto e usar regras
        específicas pra achar Número, CNPJs, Tomador, Valor a receber, etc.
      </p>
    </section>

    <section class="space-y-2">
      <div class="flex items-center justify-between">
        <h2 class="text-sm font-semibold text-slate-700">Resultado da leitura</h2>
        <p class="text-xs text-slate-500" id="statusMsg"></p>
      </div>

      <div class="border border-slate-200 rounded-xl overflow-hidden">
        <div class="overflow-auto scrollbar-thin" style="max-height: 480px;">
          <table class="min-w-full text-xs text-left text-slate-700" id="resultTable">
            <thead class="bg-slate-100 sticky top-0 z-10">
              <tr>
                <th class="px-3 py-2 border-b border-slate-200">Arquivo</th>
                <th class="px-3 py-2 border-b border-slate-200">Transportadora</th>
                <th class="px-3 py-2 border-b border-slate-200">Número CT-e</th>
                <th class="px-3 py-2 border-b border-slate-200">Data / Hora emissão</th>
                <th class="px-3 py-2 border-b border-slate-200">Remetente</th>
                <th class="px-3 py-2 border-b border-slate-200">CNPJ Remetente</th>
                <th class="px-3 py-2 border-b border-slate-200">Destinatário</th>
                <th class="px-3 py-2 border-b border-slate-200">CNPJ Destinatário</th>
                <th class="px-3 py-2 border-b border-slate-200">Tomador</th>
                <th class="px-3 py-2 border-b border-slate-200">CNPJ Tomador</th>
                <th class="px-3 py-2 border-b border-slate-200">Valor Serviço</th>
              </tr>
            </thead>
            <tbody id="resultBody">
              <!-- linhas criadas via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const fileInfo = document.getElementById("fileInfo");
    const statusMsg = document.getElementById("statusMsg");
    const resultBody = document.getElementById("resultBody");
    const btnXlsx = document.getElementById("btnXlsx");

    let rowsData = [];

    fileInput.addEventListener("change", async (e) => {
      const files = Array.from(e.target.files || []);
      rowsData = [];
      resultBody.innerHTML = "";
      btnXlsx.disabled = true;

      if (!files.length) {
        fileInfo.textContent = "Nenhum arquivo selecionado.";
        statusMsg.textContent = "";
        return;
      }

      if (!window.pdfjsLib) {
        alert("pdf.js não carregou. Confere o link do CDN.");
        return;
      }

      fileInfo.textContent = `${files.length} arquivo(s) selecionado(s).`;
      statusMsg.textContent = "Lendo PDFs... isso pode levar alguns segundos.";

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        try {
          const row = await processPdfFile(file);
          rowsData.push(row);
          appendRow(row);
        } catch (err) {
          console.error("Erro ao ler PDF", file.name, err);
          const row = {
            arquivo: file.name,
            transportadora: "ERRO AO LER",
            numero: "",
            dataHora: "",
            remetente: "",
            cnpjRemetente: "",
            destinatario: "",
            cnpjDestinatario: "",
            tomador: "",
            cnpjTomador: "",
            valorServico: ""
          };
          rowsData.push(row);
          appendRow(row);
        }
      }

      statusMsg.textContent = "Leitura concluída.";
      btnXlsx.disabled = rowsData.length === 0;
    });

    async function processPdfFile(file) {
      const arrayBuffer = await file.arrayBuffer();
      const loadingTask = window.pdfjsLib.getDocument({ data: arrayBuffer });
      const pdf = await loadingTask.promise;

      let fullText = "";
      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(" ");
        fullText += "\n" + pageText;
      }

      const parsed = parseCte(fullText);
      return {
        arquivo: file.name,
        ...parsed
      };
    }

    function parseCte(text) {
      const upper = text.normalize("NFD").replace(/\p{Mn}/gu, "").toUpperCase();

      const transportadora = detectTransportadora(upper);

      const numero = extractNumero(upper);
      const dataHora = extractDataHora(upper);
      const valorServico = extractValorServico(upper);

      const remetente = extractParte(upper, "REMETENTE");
      const destinatario = extractParte(upper, "DESTINATARIO");
      const tomadorLabel = upper.includes("TOMADOR DO SERVICO")
        ? "TOMADOR DO SERVICO"
        : "TOMADOR";

      const tomador = extractParte(upper, tomadorLabel);

      const cnpjRemetente = extractCnpj(upper, "REMETENTE");
      const cnpjDestinatario = extractCnpj(upper, "DESTINATARIO");
      const cnpjTomador = extractCnpj(upper, tomadorLabel);

      return {
        transportadora,
        numero,
        dataHora,
        remetente,
        cnpjRemetente,
        destinatario,
        cnpjDestinatario,
        tomador,
        cnpjTomador,
        valorServico
      };
    }

    function detectTransportadora(text) {
      if (text.includes("TX LOG ENCOMENDAS EXPRESSAS LTDA")) return "TX LOG";
      if (text.includes("SUDOESTE TRANSPORTES LTDA") || text.includes("SUD0ESTE TRANSPORTES LTDA")) return "SUDOESTE";
      if (text.includes("EXPRESSO SAO MIGUEL")) return "SAO MIGUEL";
      if (text.includes("EXPRESSO PRINCESA DOS CAMPOS")) return "PRINCESA";
      return "DESCONHECIDA";
    }

    function extractNumero(text) {
      let m = text.match(/NUMERO\s+([0-9]{5,9})/);
      if (m) return m[1];
      m = text.match(/NR[ºO]?\s+([0-9.]{5,})/);
      if (m) return m[1];
      return "";
    }

    function extractDataHora(text) {
      const m = text.match(/(\d{2}\/\d{2}\/\d{4})\s+(\d{2}:\d{2}(?::\d{2})?)/);
      return m ? `${m[1]} ${m[2]}` : "";
    }

    function extractValorServico(text) {
      let m = text.match(/VALOR A RECEBER[^0-9]{0,20}([0-9.]+,[0-9]{2})/);
      if (m) return m[1];
      m = text.match(/VALOR TOTAL DO SERVIC[O0][^0-9]{0,20}([0-9.]+,[0-9]{2})/);
      if (m) return m[1];
      return "";
    }

    function extractParte(text, label) {
      const idx = text.indexOf(label);
      if (idx === -1) return "";
      const slice = text.slice(idx + label.length, idx + label.length + 160);
      const cleaned = slice.replace(/\s+/g, " ").trim();
      const stopIdx = cleaned.search(/\b(ENDERECO|ENDERECO:|MUN|CNPJ|CNPJ\/CPF|CPF|UF|INSCRICAO|INSC)\b/);
      const name = stopIdx > 0 ? cleaned.slice(0, stopIdx) : cleaned;
      return name.trim();
    }

    function extractCnpj(text, label) {
      const idx = text.indexOf(label);
      if (idx === -1) return "";
      const slice = text.slice(idx, idx + 260);
      let m = slice.match(/CNPJ\/CPF[^0-9]{0,15}([0-9./-]{14,20})/);
      if (!m) {
        m = slice.match(/CNPJ[^0-9]{0,15}([0-9./-]{14,20})/);
      }
      return m ? m[1].trim() : "";
    }

    function appendRow(row) {
      const tr = document.createElement("tr");
      tr.className = "odd:bg-white even:bg-slate-50/60";

      function td(text) {
        const c = document.createElement("td");
        c.className = "px-3 py-2 border-b border-slate-200 align-top";
        c.textContent = text || "";
        return c;
      }

      tr.appendChild(td(row.arquivo));
      tr.appendChild(td(row.transportadora));
      tr.appendChild(td(row.numero));
      tr.appendChild(td(row.dataHora));
      tr.appendChild(td(row.remetente));
      tr.appendChild(td(row.cnpjRemetente));
      tr.appendChild(td(row.destinatario));
      tr.appendChild(td(row.cnpjDestinatario));
      tr.appendChild(td(row.tomador));
      tr.appendChild(td(row.cnpjTomador));
      tr.appendChild(td(row.valorServico));

      resultBody.appendChild(tr);
    }

    btnXlsx.addEventListener("click", () => {
      if (!rowsData.length) return;

      const header = [
        "Arquivo",
        "Transportadora",
        "Número CT-e",
        "Data/Hora emissão",
        "Remetente",
        "CNPJ Remetente",
        "Destinatário",
        "CNPJ Destinatário",
        "Tomador",
        "CNPJ Tomador",
        "Valor Serviço"
      ];

      const data = rowsData.map(r => [
        r.arquivo,
        r.transportadora,
        r.numero,
        r.dataHora,
        r.remetente,
        r.cnpjRemetente,
        r.destinatario,
        r.cnpjDestinatario,
        r.tomador,
        r.cnpjTomador,
        r.valorServico
      ]);

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet([header, ...data]);
      XLSX.utils.book_append_sheet(wb, ws, "CTe");

      XLSX.writeFile(wb, "cte_leitura.xlsx");
    });
  </script>
</body>
</html>
