<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel CTe</title>

    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-amber-50 via-amber-100 to-emerald-100 text-slate-900"
  >
    <main class="min-h-screen flex items-center justify-center px-4 py-8">
      <div class="w-full max-w-6xl space-y-6">
        <!-- Cabe√ßalho simples -->
        <header class="flex items-center justify-between mb-2">
          <div>
            <h1 class="text-xl font-semibold tracking-tight">
              Leitor de CT-e
            </h1>
            <p class="text-xs text-slate-600">
              Seleciona os PDFs, eu fa√ßo a parte chata.
            </p>
          </div>
        </header>

        <!-- CARD PRINCIPAL -->
        <section
          class="bg-white/95 backdrop-blur rounded-2xl border border-slate-200 shadow-sm"
        >
          <div class="px-5 py-4 border-b border-slate-100">
            <h2 class="font-semibold text-slate-900">Arquivos PDF</h2>
          </div>

          <div class="px-5 py-4 space-y-4">
            <div
              class="grid gap-3 md:grid-cols-[minmax(0,2fr)_minmax(0,1fr)] items-start"
            >
              <!-- Input de arquivos -->
              <div class="space-y-2">
                <label
                  for="pdfs"
                  class="text-xs font-medium tracking-wide text-slate-700 uppercase mb-1 inline-block"
                >
                  Selecione de 1 a 30 PDFs de CTe
                </label>
                <input
                  id="pdfs"
                  type="file"
                  accept="application/pdf"
                  multiple
                  class="block w-full text-sm text-slate-800
                    file:mr-4 file:py-2.5 file:px-4
                    file:rounded-xl file:border-0
                    file:text-sm file:font-medium
                    file:bg-slate-900 file:text-slate-50
                    hover:file:bg-slate-800 cursor-pointer"
                />
                <p id="file-count" class="text-xs text-slate-500">
                  Nenhum arquivo selecionado.
                </p>
              </div>

              <!-- Dicas -->
              <div
                class="rounded-xl bg-slate-50/80 border border-slate-200 px-3 py-3 text-xs text-slate-700"
              >
                <p class="font-semibold mb-1">Dicas r√°pidas:</p>
                <ul class="list-disc list-inside space-y-1">
                  <li>Somente CT-e em PDF (sem ZIP, sem scanner zoado).</li>
                  <li>
                    Layouts suportados: Princesa, S√£o Miguel, Sudoeste, TX LOG.
                  </li>
                  <li>
                    XLSX gerado com ponto e v√≠rgula, certinho para Excel
                    PT-BR.
                  </li>
                </ul>
              </div>
            </div>

            <!-- Erros -->
            <p id="error-msg" class="text-sm text-red-500 hidden"></p>

            <!-- Barra de progresso -->
            <div id="progress-wrapper" class="hidden">
              <div class="flex items-center justify-between mb-1">
                <span
                  id="progress-label"
                  class="text-[11px] text-slate-500 uppercase tracking-wide"
                ></span>
              </div>
              <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                <div
                  id="progress-bar"
                  class="h-2 transition-all duration-300 bg-[#367C2B]"
                  style="width: 0%"
                ></div>
              </div>
            </div>

            <!-- Bot√µes -->
            <div class="flex flex-wrap gap-3">
              <!-- Ler PDFs: verde John Deere -->
              <button
                id="btn-process"
                class="inline-flex items-center justify-center rounded-xl px-3.5 py-2.5 text-sm font-medium
                  bg-[#367C2B] text-white shadow
                  hover:bg-[#2c6321] active:scale-[0.98]
                  focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-amber-50 focus:ring-[#367C2B]"
              >
                <span class="mr-2">üìÇ</span>
                <span class="btn-process-label">Ler PDFs</span>
              </button>
            </div>
          </div>
        </section>

        <!-- RESULTADOS -->
        <section
          id="results-card"
          class="bg-white/95 backdrop-blur rounded-2xl border border-slate-200 shadow-sm hidden"
        >
          <div
            class="px-5 py-4 border-b border-slate-100 flex items-center justify-between gap-3"
          >
            <h2 class="font-semibold text-slate-900">
              Resultado da leitura
              <span id="result-count" class="text-slate-500"></span>
            </h2>

            <!-- Baixar XLSX: verde mais claro -->
            <button
              id="btn-download"
              disabled
              class="inline-flex items-center justify-center rounded-xl px-3.5 py-2 text-xs font-medium
                border border-[#58a338] text-[#245015] bg-[#e5f6da]
                hover:bg-[#d5f0c3] active:scale-[0.98]
                disabled:opacity-50 disabled:cursor-not-allowed
                focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-50 focus:ring-[#58a338]"
            >
              <span class="mr-2">üìë</span>
              <span>Baixar XLSX</span>
            </button>
          </div>

          <div class="px-5 py-4 overflow-x-auto">
            <table class="min-w-full text-sm border-collapse">
              <thead>
                <tr class="bg-slate-50 text-slate-700">
                  <th class="px-3 py-2 text-left font-medium border-b">
                    Arquivo
                  </th>
                  <th class="px-3 py-2 text-left font-medium border-b">
                    Transportadora
                  </th>
                  <th class="px-3 py-2 text-left font-medium border-b">
                    S√©rie
                  </th>
                  <th class="px-3 py-2 text-left font-medium border-b">
                    N√∫mero
                  </th>
                  <th class="px-3 py-2 text-left font-medium border-b">
                    Data / Hora emiss√£o
                  </th>
                  <th class="px-3 py-2 text-left font-medium border-b">
                    Remetente
                  </th>
                  <th class="px-3 py-2 text-left font-medium border-b">
                    CNPJ Remetente
                  </th>
                  <th class="px-3 py-2 text-left font-medium border-b">
                    Destinat√°rio
                  </th>
                  <th class="px-3 py-2 text-left font-medium border-b">
                    CNPJ Destinat√°rio
                  </th>
                  <th class="px-3 py-2 text-left font-medium border-b">
                    Tomador
                  </th>
                  <th class="px-3 py-2 text-left font-medium border-b">
                    CNPJ Tomador
                  </th>
                  <th class="px-3 py-2 text-left font-medium border-b">
                    Valor Servi√ßo
                  </th>
                  <th class="px-3 py-2 text-left font-medium border-b">
                    Erro
                  </th>
                </tr>
              </thead>
              <tbody id="results-body"></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>

    <!-- pdf.js (vers√£o est√°vel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      if (window.pdfjsLib) {
        window.pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      }
    </script>

    <!-- XLSX para exportar em .xlsx -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- L√≥gica do app -->
    <script>
      (function () {
        let selectedFiles = [];
        let rows = [];

        const input = document.getElementById("pdfs");
        const fileCount = document.getElementById("file-count");
        const errorMsg = document.getElementById("error-msg");
        const btnProcess = document.getElementById("btn-process");
        const btnDownload = document.getElementById("btn-download");
        const resultsCard = document.getElementById("results-card");
        const resultsBody = document.getElementById("results-body");
        const resultCount = document.getElementById("result-count");
        const progressWrapper = document.getElementById("progress-wrapper");
        const progressBar = document.getElementById("progress-bar");
        const progressLabel = document.getElementById("progress-label");

        function showError(msg) {
          errorMsg.textContent = msg;
          errorMsg.classList.remove("hidden");
        }

        function hideError() {
          errorMsg.textContent = "";
          errorMsg.classList.add("hidden");
        }

        function resetProgress() {
          if (!progressWrapper) return;
          progressWrapper.classList.add("hidden");
          progressBar.style.width = "0%";
          progressLabel.textContent = "";
        }

        function setProgress(current, total) {
          if (!progressWrapper) return;
          if (!total || total <= 0) {
            resetProgress();
            return;
          }
          const pct = Math.round((current / total) * 100);
          progressWrapper.classList.remove("hidden");
          progressBar.style.width = pct + "%";
          progressLabel.textContent =
            "Processando " + current + " / " + total + " PDFs (" + pct + "%)";
          if (current === total) {
            setTimeout(resetProgress, 800);
          }
        }

        input.addEventListener("change", function () {
          selectedFiles = Array.prototype.slice.call(input.files || []);
          if (selectedFiles.length === 0) {
            fileCount.textContent = "Nenhum arquivo selecionado.";
            rows = [];
            updateTable();
            resetProgress();
            return;
          }
          if (selectedFiles.length > 30) {
            showError("Selecione no m√°ximo 30 PDFs por vez.");
            selectedFiles = [];
            input.value = "";
            fileCount.textContent = "Nenhum arquivo selecionado.";
            rows = [];
            updateTable();
            resetProgress();
            return;
          }
          hideError();
          fileCount.textContent =
            "Arquivos selecionados: " + selectedFiles.length;
          rows = [];
          updateTable();
          resetProgress();
        });

        /** Extrai nome + CNPJ olhando um bloco a partir do label (REMETENTE, DESTINATARIO, TOMADOR) */
        function extractParty(text, labelUpper) {
          const upper = text.toUpperCase();
          const idx = upper.indexOf(labelUpper);
          if (idx === -1) return { name: "", cnpj: "" };

          const sliceOrig = text.slice(idx);
          const linesOrig = sliceOrig.split(/\r?\n/);
          const linesUpper = linesOrig.map(function (l) {
            return l.toUpperCase();
          });

          let name = "";
          let cnpj = "";

          const forbidden = /^(ENDERECO|ENDERE√áO|MUNICIPIO|MUNIC√çPIO|CNPJ|CPF|PAIS|PA√çS|CEP|INSCRI|FONE|TELEFONE|EXPEDIDOR|RECEBEDOR|TOMADOR|REMETENTE|DESTINATARIO|DESTINAT√ÅRIO|TIPO DO CTE|TIPO DO SERVI)/;

          for (let i = 1; i < linesUpper.length && i < 80; i++) {
            const up = linesUpper[i].trim();
            const orig = linesOrig[i].trim();

            if (!name && orig && !forbidden.test(up) && !/^[0-9 .,/:-]+$/.test(orig)) {
              name = orig;
            }

            if (!cnpj && orig) {
              let m = orig.match(/\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}/);
              if (!m) {
                m = orig.match(/CNPJ\/?CPF?:?\s*([0-9./-]{14,20})/i);
              }
              if (m) cnpj = m[1];
            }

            if (name && cnpj) break;
          }

          return { name: name || "", cnpj: cnpj || "" };
        }

        function parseCte(text) {
          const upper = text.toUpperCase();

          // Transportadora
          let transportadora = "";
          if (upper.indexOf("EXPRESSO PRINCESA DOS CAMPOS") !== -1) {
            transportadora = "EXPRESSO PRINCESA DOS CAMPOS";
          } else if (upper.indexOf("EXPRESSO SAO MIGUEL") !== -1) {
            transportadora = "EXPRESSO SAO MIGUEL";
          } else if (upper.indexOf("SUDOESTE TRANSPORTES") !== -1) {
            transportadora = "SUDOESTE TRANSPORTES";
          } else if (upper.indexOf("TX LOG ENCOMENDAS EXPRESSAS") !== -1) {
            transportadora = "TX LOG ENCOMENDAS EXPRESSAS LTDA";
          } else {
            // fallback: primeira linha n√£o vazia
            const firstLine = upper
              .split(/\r?\n/)
              .map(function (l) {
                return l.trim();
              })
              .filter(Boolean)[0];
            transportadora = firstLine || "";
          }

          // S√©rie, N√∫mero
          let serie = "";
          let numero = "";

          // Padr√£o geral MODELO / S√âRIE / N√öMERO (serve para TXLOG, PRINCESA, SUDOESTE, SAO MIGUEL)
          const m1 = upper.match(
            /MODELO[\s\r\n]+S[√âE]RIE[\s\r\n]+N[√öU]MERO[\s\S]{0,80}?([0-9]{1,3})[\s\r\n]+([0-9.]{3,})/
          );
          if (m1) {
            serie = m1[1];
            numero = m1[2];
          } else {
            // outro fallback: "SERIE NUMERO MODAL" em uma linha, valores na pr√≥xima
            const m2 = upper.match(
              /S[√âE]RIE\s+N[√öU]MERO\s+MODAL[\s\S]{0,60}?([0-9]{1,3})\s+([0-9.]{3,})/
            );
            if (m2) {
              serie = m2[1];
              numero = m2[2];
            }
          }

          // Data/Hora emiss√£o
          let dataHora = "";
          const dh1 = upper.match(
            /DATA[ \/E]*HORA[ \/A-Z]*EMISS[√ÉA]O[^\d]*([0-9]{2}\/[0-9]{2}\/[0-9]{2,4}\s+[0-9]{2}:[0-9]{2}:[0-9]{2})/
          );
          if (dh1) {
            dataHora = dh1[1];
          } else {
            const dh2 = upper.match(
              /AUTORIZA[√áC][A√É]O[^\d]*([0-9]{2}\/[0-9]{2}\/[0-9]{2,4}\s+[0-9]{2}:[0-9]{2})/
            );
            if (dh2) dataHora = dh2[1];
          }

          // Partes
          const remetente = extractParty(text, "REMETENTE");
          const destinatario = extractParty(text, "DESTINATARIO");
          let tomador = extractParty(text, "TOMADOR DO SERVI");
          if (!tomador.name && !tomador.cnpj) {
            tomador = extractParty(text, "TOMADOR");
          }

          // Valor do servi√ßo / a receber
          let valorServico = "";
          const v1 = upper.match(
            /VALOR A RECEBER[^0-9]*([0-9.]+,[0-9]{2})/
          );
          if (v1) {
            valorServico = v1[1];
          } else {
            const v2 = upper.match(
              /VALOR TOTAL DO SERVI[√áC]O[^0-9]*([0-9.]+,[0-9]{2})/
            );
            if (v2) valorServico = v2[1];
          }

          return {
            transportadora: transportadora,
            serie: serie,
            numero: numero,
            dataHora: dataHora,
            remetente: remetente,
            destinatario: destinatario,
            tomador: tomador,
            valorServico: valorServico,
          };
        }

        async function readPdfFile(file) {
          if (!window.pdfjsLib || !window.pdfjsLib.getDocument) {
            throw new Error("pdf.js n√£o carregou.");
          }
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await window.pdfjsLib
            .getDocument({ data: arrayBuffer })
            .promise;
          let fullText = "";
          for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            const content = await page.getTextContent();
            const strings = content.items.map(function (it) {
              return it.str;
            });
            fullText += strings.join("\n") + "\n";
          }
          return parseCte(fullText);
        }

        function updateTable() {
          resultsBody.innerHTML = "";
          if (!rows.length) {
            resultsCard.classList.add("hidden");
            btnDownload.disabled = true;
            resultCount.textContent = "";
            return;
          }
          resultsCard.classList.remove("hidden");
          btnDownload.disabled = false;
          resultCount.textContent =
            "(" + rows.length + " CT-e" + (rows.length > 1 ? "s" : "") + ")";

          for (let i = 0; i < rows.length; i++) {
            const r = rows[i];
            const tr = document.createElement("tr");
            tr.className = "bg-white/90 hover:bg-emerald-50";

            const remetenteNome =
              r.remetente && r.remetente.name ? r.remetente.name : "";
            const remetenteCnpj =
              r.remetente && r.remetente.cnpj ? r.remetente.cnpj : "";
            const destinatarioNome =
              r.destinatario && r.destinatario.name
                ? r.destinatario.name
                : "";
            const destinatarioCnpj =
              r.destinatario && r.destinatario.cnpj
                ? r.destinatario.cnpj
                : "";
            const tomadorNome =
              r.tomador && r.tomador.name ? r.tomador.name : "";
            const tomadorCnpj =
              r.tomador && r.tomador.cnpj ? r.tomador.cnpj : "";

            const cells = [
              r.fileName || "",
              r.transportadora || "",
              r.serie || "",
              r.numero || "",
              r.dataHora || "",
              remetenteNome,
              remetenteCnpj,
              destinatarioNome,
              destinatarioCnpj,
              tomadorNome,
              tomadorCnpj,
              r.valorServico || "",
              r.error || "",
            ];

            for (let j = 0; j < cells.length; j++) {
              const td = document.createElement("td");
              td.className = "px-3 py-2 align-top text-sm text-slate-900";
              td.textContent = cells[j];
              tr.appendChild(td);
            }
            resultsBody.appendChild(tr);
          }
        }

        function toCsvRow(values) {
          return values
            .map(function (v) {
              const s = (v == null ? "" : String(v)).replace(/"/g, '""');
              return '"' + s + '"';
            })
            .join(";");
        }

        function buildAoA() {
          const header = [
            "Arquivo",
            "Transportadora",
            "Serie",
            "Numero",
            "DataHora",
            "RemetenteNome",
            "RemetenteCNPJ",
            "DestinatarioNome",
            "DestinatarioCNPJ",
            "TomadorNome",
            "TomadorCNPJ",
            "ValorServico",
          ];

          const data = [];
          for (let i = 0; i < rows.length; i++) {
            const r = rows[i];
            const remetenteNome =
              r.remetente && r.remetente.name ? r.remetente.name : "";
            const remetenteCnpj =
              r.remetente && r.remetente.cnpj ? r.remetente.cnpj : "";
            const destinatarioNome =
              r.destinatario && r.destinatario.name
                ? r.destinatario.name
                : "";
            const destinatarioCnpj =
              r.destinatario && r.destinatario.cnpj
                ? r.destinatario.cnpj
                : "";
            const tomadorNome =
              r.tomador && r.tomador.name ? r.tomador.name : "";
            const tomadorCnpj =
              r.tomador && r.tomador.cnpj ? r.tomador.cnpj : "";

            data.push([
              r.fileName || "",
              r.transportadora || "",
              r.serie || "",
              r.numero || "",
              r.dataHora || "",
              remetenteNome,
              remetenteCnpj,
              destinatarioNome,
              destinatarioCnpj,
              tomadorNome,
              tomadorCnpj,
              r.valorServico || "",
            ]);
          }

          return { header: header, data: data };
        }

        function handleDownload() {
          if (!rows.length) return;

          const aoa = buildAoA();

          if (window.XLSX) {
            const sheetData = [aoa.header].concat(aoa.data);
            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "CTe");
            XLSX.writeFile(wb, "cte-extracao.xlsx");
          } else {
            const lines = [aoa.header.join(";")];
            for (let i = 0; i < aoa.data.length; i++) {
              lines.push(toCsvRow(aoa.data[i]));
            }
            const csv = lines.join("\r\n");
            const blob = new Blob([csv], {
              type: "text/csv;charset=utf-8;",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "cte-extracao.csv";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }
        }

        async function handleProcess() {
          if (!selectedFiles.length) return;
          hideError();
          btnProcess.disabled = true;
          const labelSpan =
            btnProcess.querySelector(".btn-process-label");
          if (labelSpan) labelSpan.textContent = "Processando PDFs...";

          rows = [];
          const total = selectedFiles.length;
          setProgress(0, total);

          for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            setProgress(i, total);
            try {
              const parsed = await readPdfFile(file);
              rows.push({
                fileName: file.name,
                transportadora: parsed.transportadora,
                serie: parsed.serie,
                numero: parsed.numero,
                dataHora: parsed.dataHora,
                remetente: parsed.remetente,
                destinatario: parsed.destinatario,
                tomador: parsed.tomador,
                valorServico: parsed.valorServico,
                error: "",
              });
            } catch (err) {
              console.error(err);
              rows.push({
                fileName: file.name,
                transportadora: "",
                serie: "",
                numero: "",
                dataHora: "",
                remetente: { name: "", cnpj: "" },
                destinatario: { name: "", cnpj: "" },
                tomador: { name: "", cnpj: "" },
                valorServico: "",
                error: "Falha ao ler PDF",
              });
            }
            setProgress(i + 1, total);
          }

          updateTable();
          btnProcess.disabled = false;
          if (labelSpan) labelSpan.textContent = "Ler PDFs";
        }

        btnProcess.addEventListener("click", function () {
          handleProcess();
        });

        btnDownload.addEventListener("click", function () {
          handleDownload();
        });
      })();
    </script>
  </body>
</html>
